name: Publish to MCP Hive

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      force_publish:
        description: "Force publish even if not a release"
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      MCP_SERVER_URL: https://mcp-hive.ti.trilogy.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Verify required secrets
        run: |
          [ -n "${{ secrets.MCP_HIVE_API_KEY }}" ] || { echo "âŒ MCP_HIVE_API_KEY missing"; exit 1; }
          [ -n "${{ secrets.MCP_HIVE_ID }}" ] || { echo "âŒ MCP_HIVE_ID missing"; exit 1; }
          [ -n "${{ secrets.WRIKE_ACCESS_TOKEN }}" ] || { echo "âŒ WRIKE_ACCESS_TOKEN missing"; exit 1; }
          [ -n "${{ secrets.OPENAI_API_KEY }}" ] || { echo "âŒ OPENAI_API_KEY missing"; exit 1; }
          [ -n "${{ secrets.DD_TEMPLATE_GOOGLE_DOC_ID }}" ] || { echo "âŒ DD_TEMPLATE_GOOGLE_DOC_ID missing"; exit 1; }
          [ -n "${{ secrets.GOOGLE_DRIVE_ROOT_FOLDER_ID }}" ] || { echo "âŒ GOOGLE_DRIVE_ROOT_FOLDER_ID missing"; exit 1; }
          [ -n "${{ secrets.OAUTH_CLIENT_ID }}" ] || { echo "âŒ OAUTH_CLIENT_ID missing"; exit 1; }
          [ -n "${{ secrets.OAUTH_CLIENT_SECRET }}" ] || { echo "âŒ OAUTH_CLIENT_SECRET missing"; exit 1; }
          [ -n "${{ secrets.OAUTH_REFRESH_TOKEN }}" ] || { echo "âŒ OAUTH_REFRESH_TOKEN missing"; exit 1; }
          echo "âœ… All required secrets are present"

      - name: Get version from pyproject.toml
        id: get_version
        run: |
          python -c "import tomllib,sys;print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])" | tee version.txt
          echo "version=$(cat version.txt)" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Found version: $(cat version.txt)"

      - name: Create .env file from GitHub secrets
        env:
          WRIKE_ACCESS_TOKEN: ${{ secrets.WRIKE_ACCESS_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DD_TEMPLATE_GOOGLE_DOC_ID: ${{ secrets.DD_TEMPLATE_GOOGLE_DOC_ID }}
          GOOGLE_DRIVE_ROOT_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_ROOT_FOLDER_ID }}
        run: |
          touch .env
          echo "WRIKE_ACCESS_TOKEN=${WRIKE_ACCESS_TOKEN}" >> .env
          echo "OPENAI_API_KEY=${OPENAI_API_KEY}" >> .env
          echo "DD_TEMPLATE_GOOGLE_DOC_ID=${DD_TEMPLATE_GOOGLE_DOC_ID}" >> .env
          echo "GOOGLE_DRIVE_ROOT_FOLDER_ID=${GOOGLE_DRIVE_ROOT_FOLDER_ID}" >> .env
          echo "âœ… Created .env file with secrets"

      - name: Create custom payload file
        run: |
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          cat > custom_payload.json << JSON
          {
            "hiveName": "Alpha DD Report Generator",
            "hiveDescription": "Model Context Protocol server for generating Alpha School Due Diligence reports. Reads site data from Wrike and Google Drive, applies E-Occupancy and School Approval scoring, and creates a completed DD report Google Doc.",
            "version": "${{ steps.get_version.outputs.version }}",
            "tags": ["wrike", "alpha-due-diligence", "google-docs"],
            "homePage": "${REPO_URL}",
            "env": [],
            "securitySchemes": [
              {
                "id": "oauth2",
                "type": "oauth2",
                "flows": {
                  "authorizationCode": {
                    "authorizationUrl": "https://accounts.google.com/o/oauth2/v2/auth",
                    "tokenUrl": "https://oauth2.googleapis.com/token",
                    "scopes": {
                      "https://www.googleapis.com/auth/drive": "Read and write files in Google Drive",
                      "https://www.googleapis.com/auth/documents": "Create and edit Google Docs"
                    }
                  }
                }
              }
            ],
            "oAuthClient": {
              "clientId": "${{ secrets.OAUTH_CLIENT_ID }}",
              "clientSecret": "${{ secrets.OAUTH_CLIENT_SECRET }}"
            }
          }
          JSON
          echo "ðŸ“‹ Custom payload:"; cat custom_payload.json

      - name: Create ZIP for MCP Hive
        run: |
          ZIP_PATH="../due-diligence-reporter-mcp.zip"
          zip -r "$ZIP_PATH" . \
            -x "*.git*" \
            "*/__pycache__/*" \
            "*.DS_Store" \
            "build/*" \
            "*.egg-info/*" \
            ".venv/*" \
            ".ruff_cache/*"
          echo "ðŸ“¦ Created zip: $ZIP_PATH"; ls -la "$ZIP_PATH"

      - name: Publish to MCP Hive
        env:
          API_KEY: ${{ secrets.MCP_HIVE_API_KEY }}
          HIVE_ID: ${{ secrets.MCP_HIVE_ID }}
        run: |
          ZIP_PATH="../due-diligence-reporter-mcp.zip"
          CONFIG_JSON=$(jq -c '.' custom_payload.json)
          curl -sS -X PUT "$MCP_SERVER_URL/api/hives/$HIVE_ID/from-mcp-server" \
            -H "x-api-key: $API_KEY" \
            -F "zipFile=@${ZIP_PATH};type=application/zip" \
            --form-string "data=${CONFIG_JSON}"
          echo "\nâœ… Publish request sent"

      - name: Done
        run: |
          echo "ðŸŽ‰ Successfully initiated publish to MCP Hive"
